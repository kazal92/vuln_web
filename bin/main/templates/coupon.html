<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragments/layout}">

<head>
    <title>ì´ë²¤íŠ¸ - Securecorp Mall</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Event Banner Section -->
        <div class="bg-light py-5 mb-5 text-center"
            style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);">
            <div class="container fade-in">
                <span class="badge bg-danger rounded-pill px-3 py-2 mb-3 shadow-sm">Limited Time Offer</span>
                <h1 class="display-4 fw-bold text-dark mb-3">ğŸ‰ ì„ ì°©ìˆœ 10ëª… í•œì • íŠ¹ê°€!</h1>
                <p class="lead text-muted mb-4">ì§€ê¸ˆ ë°”ë¡œ 50% í• ì¸ ì¿ í°ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.<br>ë†“ì¹˜ë©´ í›„íšŒí•  íŠ¹ë³„í•œ ê¸°íšŒì…ë‹ˆë‹¤.</p>
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <span class="fs-4 fw-bold text-danger"
                        th:text="'ë‚¨ì€ ìˆ˜ëŸ‰: ' + ${coupon.remainingCount} + 'ê°œ'">100ê°œ</span>
                    <span class="fs-4 fw-bold text-primary ms-3" th:text="'ë‚´ ì¿ í°: ' + ${myCouponCount} + 'ì¥'">0ì¥</span>
                </div>
            </div>
        </div>

        <div class="container mb-5">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                        <div class="card-body p-5 text-center">
                            <i class="bi bi-ticket-perforated-fill text-danger display-1 mb-4"></i>
                            <h3 class="fw-bold mb-3">50% í• ì¸ ì¿ í°</h3>
                            <p class="text-muted mb-4">
                                ì „ ìƒí’ˆ ì ìš© ê°€ëŠ¥!<br>
                                1ì¸ë‹¹ 1ë§¤ë§Œ ë°œê¸‰ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„œë‘ë¥´ì„¸ìš”!
                            </p>

                            <form id="couponForm">
                                <!-- HIDDEN IDOR VECTOR -->
                                <input type="hidden" id="username" name="username" th:value="${currentUsername}">

                                <div class="d-grid gap-2">
                                    <button type="button" onclick="issueCoupon()"
                                        class="btn btn-dark btn-lg rounded-pill py-3">
                                        <i class="bi bi-download me-2"></i> ì¿ í° ë°œê¸‰ë°›ê¸°
                                    </button>
                                </div>
                            </form>

                            <!-- Reset Button for Testing -->
                            <div class="mt-3">
                                <button type="button" onclick="resetEvent()"
                                    class="btn btn-outline-secondary btn-sm rounded-pill">
                                    <i class="bi bi-arrow-counterclockwise"></i> ì´ë²¤íŠ¸ ë¦¬ì…‹ (í…ŒìŠ¤íŠ¸ìš©)
                                </button>
                            </div>

                            <div id="result" class="mt-4 fw-bold min-h-20"></div>

                        </div>
                        <div class="card-footer bg-light text-center py-3 text-muted small">
                            * ë³¸ ì´ë²¤íŠ¸ëŠ” ì‚¬ì •ì— ì˜í•´ ì¡°ê¸° ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function issueCoupon() {
                var username = document.getElementById("username").value;
                var resultDiv = document.getElementById("result");
                var btn = document.querySelector("#couponForm button");

                if (username == "") {
                    // ê°„ë‹¨í•œ í”„ë¡ íŠ¸ ì²´í¬ (ë¡œê·¸ì¸ ìœ ë„)
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    location.href = "/login";
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ì²˜ë¦¬ì¤‘...';

                fetch('/api/coupon/issue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=' + username
                })
                    .then(response => response.text())
                    .then(data => {
                        resultDiv.innerText = data;
                        if (data.includes("ì¶•í•˜í•©ë‹ˆë‹¤")) {
                            resultDiv.className = "mt-4 fw-bold text-success fade-in";
                            // ì„±ê³µ íš¨ê³¼ (í­ì£½ ë“±) ëŒ€ì‹  ê°„ë‹¨í•œ UI í”¼ë“œë°±
                        } else {
                            resultDiv.className = "mt-4 fw-bold text-danger fade-in";
                        }
                        // ê°œìˆ˜ ê°±ì‹ ì„ ìœ„í•´ 1ì´ˆ ë’¤ ìƒˆë¡œê³ ì¹¨ (ì„ íƒ)
                        setTimeout(() => location.reload(), 1500);
                    })
                    .catch(error => {
                        resultDiv.innerText = "ì—ëŸ¬ ë°œìƒ: " + error;
                        resultDiv.className = "mt-4 fw-bold text-danger";
                    })
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-download me-2"></i> ì¿ í° ë°œê¸‰ë°›ê¸°';
                    });
            }

            function resetEvent() {
                if (!confirm("ì •ë§ ì´ë²¤íŠ¸ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ë°œê¸‰ ë‚´ì—­ì´ ì‚­ì œë˜ê³  ìˆ˜ëŸ‰ì´ 10ê°œë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) return;

                fetch('/admin/coupon/reset')
                    .then(response => response.text())
                    .then(data => {
                        alert(data);
                        location.reload();
                    });
            }
        </script>

        <style>
            .min-h-20 {
                min-height: 1.5rem;
            }

            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </div>
</body>

</html>