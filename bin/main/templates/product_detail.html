<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head}"></head>

<body>

    <nav th:replace="~{fragments/layout :: nav}"></nav>

    <div class="container fade-in mt-5">
        <div class="row gx-5">
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-lg overflow-hidden rounded-4">
                    <img th:src="${product.imageUrl}" class="img-fluid w-100 object-fit-cover" style="height: 500px;"
                        alt="Product Image">
                </div>
            </div>
            <div class="col-md-6">
                <div class="h-100 d-flex flex-column justify-content-center">
                    <h1 class="display-5 fw-bold text-dark mb-2" th:text="${product.name}">Product Name</h1>
                    <div class="mb-4">
                        <span class="h2 text-primary fw-bold"
                            th:text="${'₩' + #numbers.formatInteger(product.price, 0, 'COMMA')}">Price</span>
                    </div>

                    <p class="lead text-muted mb-5" th:text="${product.description}">Description</p>

                    <div class="card bg-light border-0 rounded-4 p-4">
                        <form action="/order/create" method="post">
                            <input type="hidden" name="productId" th:value="${product.id}">
                            <div class="row g-3 align-items-end">
                                <div class="col-4">
                                    <label for="quantity"
                                        class="form-label fw-bold small text-uppercase text-muted">수량</label>
                                    <input type="number" id="quantity" name="quantity"
                                        class="form-control form-control-lg border-0 bg-white" value="1" min="1">
                                </div>
                                <div class="col-8">
                                    <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">
                                        <i class="bi bi-cart-plus me-2"></i> 구매하기
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section (To be implemented for Stored XSS) -->
        <!-- Reviews Section -->
        <div class="row mt-5 mb-5">
            <div class="col-12">
                <div class="d-flex align-items-center mb-4">
                    <h3 class="fw-bold m-0 me-2">리뷰</h3>
                    <span class="badge bg-secondary rounded-pill"
                        th:text="${reviews != null ? reviews.size() : 0}">0</span>
                </div>

                <!-- Review Form -->
                <div class="card border-0 shadow-sm rounded-4 mb-5" th:if="${session.user != null}">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">리뷰 작성</h5>
                        <form action="/review/create" method="post">
                            <input type="hidden" name="productId" th:value="${product.id}">
                            <div class="mb-3">
                                <textarea name="content" class="form-control bg-light border-0" rows="3"
                                    placeholder="이 상품에 대한 솔직한 리뷰를 남겨주세요." required></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">등록</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="alert alert-info border-0 shadow-sm rounded-4 mb-5" th:if="${session.user == null}">
                    <i class="bi bi-info-circle-fill me-2"></i> 리뷰를 작성하려면 <a href="/login"
                        class="alert-link fw-bold">로그인</a>하세요.
                </div>

                <!-- Review List -->
                <div class="d-flex flex-column gap-3">
                    <div th:each="review : ${reviews}" class="card border-0 shadow-sm rounded-4">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center fw-bold"
                                        style="width: 40px; height: 40px;"
                                        th:text="${#strings.substring(review.username, 0, 1).toUpperCase()}">U</div>
                                    <div>
                                        <div class="fw-bold text-dark" th:text="${review.username}">User</div>
                                        <div class="small text-muted"
                                            th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">Date
                                        </div>
                                    </div>
                                </div>
                                <!-- Edit/Delete Buttons (Visible only to Author) -->
                                <div class="d-flex gap-2"
                                    th:if="${session.user != null && session.user == review.username}">
                                    <button class="btn btn-sm btn-outline-secondary"
                                        th:onclick="'document.getElementById(\'edit-form-' + ${review.id} + '\').classList.toggle(\'d-none\')'">
                                        <i class="bi bi-pencil"></i> 수정
                                    </button>
                                    <form action="/review/delete" method="post"
                                        onsubmit="return confirm('정말 삭제하시겠습니까?');">
                                        <input type="hidden" name="id" th:value="${review.id}">
                                        <input type="hidden" name="productId" th:value="${product.id}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i> 삭제
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Review Content -->
                            <!-- VULNERABILITY: Stored XSS -->
                            <!-- using th:utext renders raw HTML from database without escaping -->
                            <div class="review-content text-dark" th:utext="${review.content}">Review Content</div>

                            <!-- Hidden Edit Form -->
                            <div th:id="'edit-form-' + ${review.id}" class="d-none mt-3 p-3 bg-light rounded-3">
                                <form action="/review/update" method="post">
                                    <input type="hidden" name="id" th:value="${review.id}">
                                    <input type="hidden" name="productId" th:value="${product.id}">
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control" rows="2"
                                            th:text="${review.content}"></textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary btn-sm">수정 완료</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div th:if="${reviews == null || reviews.isEmpty()}" class="text-center py-5 text-muted opacity-50">
                        <i class="bi bi-chat-square-text fs-1 mb-3 d-block"></i>
                        <p>아직 작성된 리뷰가 없습니다. 첫 리뷰를 남겨보세요!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>

</body>

</html>